<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pong</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRfu8m1L/J1Rv2hFpgb8si5+KclW5hqIcWPL6jIoS"
      crossorigin="anonymous"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="static/css/main.css" />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gradient">
    <!-- Bloc “titre” au-dessus du container -->
    <div class="title-block text-center">
      <!-- Image ou logo “PONG” -->
      <img
        src="/static/img/Game_anime.png"
        alt="Game Title"
        class="img-fluid"
      />
    </div>

    <!-- Container principal -->
    <div class="container text-center bg-white shadow-lg rounded p-4 welcome-container">
      <p class="text-muted">Please sign in to continue</p>
      <h1 class="display-6 text-primary"></h1>

      <!-- Ligne 1: Boutons Login et Sign Up -->
      <div class="btn-group w-100 mb-3 d-flex" role="group">
        <button
          id="login-btn"
          class="btn active d-flex align-items-center justify-content-center"
          style="font-size: 16px; flex: 1; border-radius: 9px; border: none;"
        >
          <i class="bi bi-box-arrow-in-right" style="font-size: 20px; margin-right: 8px;"></i>
          Login
        </button>
        <button
          id="signup-btn"
          class="btn d-flex align-items-center justify-content-center"
          style="font-size: 16px; flex: 1; border-radius: 9px; border: none;"
        >
          <i class="bi bi-person-plus" style="font-size: 20px; margin-right: 8px;"></i>
          Sign Up
        </button>
      </div>

      <!-- Ligne 2: Case à cocher et texte en deux lignes -->
      <div class="tos-container mb-3">
        <div class="tos-line">
          <input type="checkbox" id="tos-checkbox" />
          <label for="tos-checkbox">I have read and agree to the</label>
        </div>
        <div class="tos-links">
          <a href="terms.html" target="_blank">Terms of Service</a>
          <span> and </span>
          <a href="privacy.html" target="_blank">Privacy Policy</a>
        </div>
      </div>

      <!-- Ligne 3: Texte RGPD -->
      <p class="gdpr-text mb-3">Your data is processed according to GDPR regulations.</p>

      <!-- Ligne 4: Bouton "Sign in with 42" -->
      <button id="connect-42" class="auth-button">
        <span>SIGN IN WITH</span>    
        <img src="static/img/42_logo.png" alt="42 Logo" />
      </button>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    ></script>
    <!-- Custom JS -->
    <script src="static/js/main.js"></script>

    <script>
      (function() {
        const MAX_LOGS_PER_SESSION = 100;
        let logCount = 0;
        let isSendingLog = false;
        const recentLogs = new Set(); // pour éviter les doublons immédiats
    
        // Fonction utilitaire : génère une signature simple d’un log
        function getLogSignature(logData) {
          return `${logData.message}-${logData.source || ''}-${logData.lineno || ''}`;
        }
    
        // Fonction d’envoi de log vers le backend
        function sendLog(logData) {
          if (logCount >= MAX_LOGS_PER_SESSION) return;
          const signature = getLogSignature(logData);
          if (recentLogs.has(signature)) return;
    
          recentLogs.add(signature);
          setTimeout(() => recentLogs.delete(signature), 5000); // nettoie après 5 sec
    
          isSendingLog = true;
          logCount++;
    
          fetch('/api/logs/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(logData)
          }).catch(function(error) {
            // On log l'erreur dans la console d'origine, sans relancer sendLog
            originalConsoleError("Erreur lors de l'envoi du log :", error);
          }).finally(() => {
            isSendingLog = false;
          });
        }
    
        // Gestion des erreurs JS globales
        window.onerror = function(message, source, lineno, colno, error) {
          sendLog({
            message,
            source,
            lineno,
            colno,
            error: error ? error.stack : null,
            level: 'ERROR',
            type: 'js-error'
          });
          return false;
        };
    
        // Gestion des promesses non gérées
        window.onunhandledrejection = function(event) {
          sendLog({
            message: event.reason ? event.reason.toString() : 'Unhandled promise rejection',
            level: 'ERROR',
            source: 'Promise',
            type: 'promise-rejection'
          });
        };
    
        // Erreurs de chargement de ressources
        window.addEventListener('error', function(event) {
          if (event.target && (event.target.src || event.target.href)) {
            const resource = event.target.src || event.target.href;
            sendLog({
              message: 'Erreur de chargement de ressource',
              resource,
              tagName: event.target.tagName,
              level: 'ERROR',
              type: 'resource-error'
            });
          }
        }, true);
    
        // Redéfinir console.error avec précaution
        const originalConsoleError = console.error;
        console.error = function(...args) {
          const message = args.join(' ');
    
          // Ne pas logger les erreurs générées par sendLog
          if (isSendingLog || message.includes('Erreur lors de l\'envoi du log')) {
            originalConsoleError.apply(console, args);
            return;
          }
    
          sendLog({
            message,
            level: 'ERROR',
            type: 'console-error'
          });
    
          originalConsoleError.apply(console, args);
        };
      })();
    </script> 
  </body>
</html>
